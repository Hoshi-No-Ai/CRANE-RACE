#include "gyro.h"

fp64 GyroData, gyroGz;
fp64 GyroTab[3];

fp64 Angel_d;
fp64 Angel_v;
fp64 RobAngel, TestAngle, TestAngle2;
fp32 value_door = 2;
int CalFlag;
int GyroCount = 1;
Bw50HzLPFTypeDef GyroLPF;

double AD_Table[AD_Num] = {18812.10011,  16851.32424,  16654.07131,  16459.15144,  16260.87222,
                           16064.47734,  15863.607,    15661.50761,  15459.66597,  15255.41528,
                           15050.11315,  14844.62502,  14635.59587,  14424.43498,  14213.82062,
                           14001.50027,  13790.13926,  13573.48305,  13358.69488,  13142.13466,
                           12920.43491,  12702.39994,  12483.86656,  12257.28008,  12034.57161,
                           11809.41086,  11585.23481,  11357.22894,  11133.89765,  10902.15302,
                           10673.35708,  10443.65395,  10209.47912,  9979.029665,  9743.765203,
                           9514.263887,  9273.277793,  9040.601573,  8801.196483,  8568.035553,
                           8327.146234,  8088.377672,  7849.247333,  7607.082655,  7368.495989,
                           7121.18356,   6881.405288,  6642.04375,   6393.201488,  6148.422303,
                           5904.967907,  5661.866759,  5414.549942,  5165.963105,  4919.97375,
                           4673.628087,  4426.938887,  4182.071023,  3931.774203,  3684.918381,
                           3431.971336,  3182.409971,  2931.663441,  2681.046895,  2429.430542,
                           2180.010637,  1928.13246,   1677.883556,  1424.628545,  1173.54086,
                           920.9795042,  670.5468848,  586.9950035,  503.1609914,  419.0875456,
                           334.5854167,  250.6989739,  167.0336829,  83.01107026,  0,
                           -83.73893551, -167.8629167, -251.5427365, -335.7978649, -420.5146442,
                           -504.576405,  -588.38125,   -672.4443097, -925.85625,   -1174.990676,
                           -1426.631969, -1678.478614, -1928.63428,  -2180.46266,  -2431.507532,
                           -2683.351599, -2933.397618, -3181.179142, -3430.925991, -3684.121813,
                           -3931.527679, -4179.069543, -4425.73244,  -4676.593028, -4920.814851,
                           -5171.010598, -5414.815625, -5660.596661, -5908.716836, -6153.61335,
                           -6398.836189, -6642.670771, -6881.704089, -7123.150602, -7370.334588,
                           -7610.144323, -7852.740595, -8091.813393, -8326.80659,  -8569.995466,
                           -8804.395413, -9041.925305, -9279.830832, -9515.092304, -9747.567361,
                           -9983.788453, -10214.66531, -10447.21976, -10677.03556, -10907.53761,
                           -11133.72224, -11362.92866, -11589.54775, -11815.1364,  -12036.31484,
                           -12259.86175, -12480.48073, -12706.77132, -12923.61519, -13146.96334,
                           -13361.76672, -13579.92177, -13790.53567, -14005.20515, -14218.15409,
                           -14428.54206, -14640.4149,  -14846.57682, -15053.39722, -15259.77645,
                           -15462.02536, -15665.88878, -15867.27694, -16066.79454, -16265.00217,
                           -16461.78444, -16655.7799,  -16851.28611, -18812.59284, -20104.9393};

double AD_Table_a[AD_Num] = {
    -0.037525039, -0.01632007,  -0.0152089,   -0.01539094,  -0.015130178, -0.015275348, -0.014935007,
    -0.014844181, -0.014863138, -0.014687833, -0.01461261,  -0.014599384, -0.014352065, -0.014207176,
    -0.014244043, -0.014129592, -0.014193724, -0.013846822, -0.01396725,  -0.01385296,  -0.013531815,
    -0.013759261, -0.01372788,  -0.013239978, -0.013470525, -0.013323814, -0.013382339, -0.013157556,
    -0.013432959, -0.012945284, -0.013112121, -0.013060336, -0.012810941, -0.013018039, -0.012751607,
    -0.01307182,  -0.012448851, -0.012893453, -0.012531062, -0.01286665,  -0.012453852, -0.012564468,
    -0.01254546,  -0.012388264, -0.012574047, -0.012130405, -0.012511559, -0.012533342, -0.01205583,
    -0.012255944, -0.012322636, -0.012340542, -0.01213019,  -0.012068217, -0.01219565,  -0.01217801,
    -0.012161051, -0.012251506, -0.01198577,  -0.012152843, -0.01186019,  -0.012021091, -0.011964273,
    -0.011970479, -0.011922913, -0.012027909, -0.01191052,  -0.011988064, -0.011845768, -0.011948017,
    -0.011878302, -0.01197927,  -0.011968611, -0.011928333, -0.011894362, -0.011834021, -0.011920877,
    -0.011952388, -0.011901558, -0.012046586, -0.011941876, -0.011887217, -0.011950313, -0.011868714,
    -0.011804037, -0.011896015, -0.011932484, -0.011895832, -0.011838432, -0.012041692, -0.011921732,
    -0.011912011, -0.011992533, -0.011912875, -0.011950055, -0.011912133, -0.011997791, -0.01210744,
    -0.012012164, -0.011848537, -0.012125824, -0.012119162, -0.012162348, -0.011958834, -0.012283915,
    -0.011990611, -0.012304914, -0.012205986, -0.012090915, -0.012250072, -0.012233771, -0.012303423,
    -0.012550552, -0.012425112, -0.012136709, -0.012509917, -0.012366225, -0.012548479, -0.012766327,
    -0.012336091, -0.012798638, -0.012629989, -0.012610048, -0.012751769, -0.01290461,  -0.012699967,
    -0.01299394,  -0.012900204, -0.013053933, -0.013015069, -0.0132635,   -0.013088639, -0.013238073,
    -0.013298542, -0.013563709, -0.013420002, -0.013598105, -0.01325729,  -0.013834839, -0.013431945,
    -0.013966261, -0.013751687, -0.014244074, -0.013974972, -0.014087884, -0.014259371, -0.014159437,
    -0.014551669, -0.014505339, -0.014536347, -0.014833207, -0.014715735, -0.014896605, -0.015036267,
    -0.015135643, -0.015245276, -0.015464279, -0.015344781, -0.016315653, -0.038689315};

double AD_Table_b[AD_Num] = {455.9247986,
                             57.01479504,
                             38.29009939,
                             41.3218145,
                             37.02989352,
                             39.39047887,
                             33.92308598,
                             32.4822507,
                             32.77914507,
                             30.06898521,
                             28.92143398,
                             28.72238001,
                             25.05102202,
                             22.9304921,
                             23.46227683,
                             21.83549044,
                             22.73343527,
                             17.94960654,
                             19.58422531,
                             18.05746489,
                             13.83693265,
                             16.77563327,
                             16.37702087,
                             10.28612339,
                             13.11199664,
                             11.34639331,
                             12.03754303,
                             9.433374447,
                             12.56118812,
                             7.131467984,
                             8.950348347,
                             8.397627513,
                             5.793037755,
                             7.907395622,
                             5.2486661,
                             8.368748997,
                             2.441654412,
                             6.564575385,
                             3.288337847,
                             6.241911788,
                             2.705049386,
                             3.626163814,
                             3.472414993,
                             2.238549312,
                             3.651816333,
                             0.382843035,
                             3.097108367,
                             3.247005254,
                             0.075350133,
                             1.354719804,
                             1.764772529,
                             1.870506102,
                             0.679520016,
                             0.343965974,
                             1.002276357,
                             0.915490661,
                             0.836230486,
                             1.236666423,
                             0.125339449,
                             0.782233941,
                             -0.296168073,
                             0.256041331,
                             0.075222524,
                             0.093414411,
                             -0.034109812,
                             0.22097026,
                             -0.034940339,
                             0.114576288,
                             -0.124181324,
                             0.021486448,
                             -0.060327517,
                             0.032662276,
                             0.025515096,
                             0.001871779,
                             -0.015221015,
                             -0.040509028,
                             -0.011448268,
                             -0.003548653,
                             -0.01203893,
                             0,
                             0,
                             0.004577121,
                             -0.006014318,
                             0.014511268,
                             0.036229566,
                             -0.002448673,
                             -0.020850051,
                             0.000715747,
                             0.039313827,
                             -0.148875697,
                             -0.007923708,
                             0.00594435,
                             -0.12920963,
                             0.024420989,
                             -0.056648495,
                             0.035559069,
                             -0.194292958,
                             -0.515936501,
                             -0.212844167,
                             0.348547384,
                             -0.673012943,
                             -0.64682152,
                             -0.827298147,
                             0.073402616,
                             -1.446869172,
                             -0.003579055,
                             -1.628842987,
                             -1.093166267,
                             -0.441794216,
                             -1.382208568,
                             -1.281894973,
                             -1.72758815,
                             -3.369182802,
                             -2.505944828,
                             -0.451602881,
                             -3.202277586,
                             -2.108754494,
                             -3.539951015,
                             -5.302735822,
                             -1.720240446,
                             -5.684266729,
                             -4.199420131,
                             -4.019107953,
                             -5.334261034,
                             -6.788557705,
                             -4.793780654,
                             -7.728747608,
                             -6.771270615,
                             -8.377306185,
                             -7.962353238,
                             -10.67212806,
                             -8.725266565,
                             -10.42327665,
                             -11.12408477,
                             -14.2570729,
                             -12.52736853,
                             -14.71088636,
                             -10.45735148,
                             -17.79613212,
                             -12.58928318,
                             -19.61391965,
                             -16.74683758,
                             -23.43340733,
                             -19.72235499,
                             -21.30370503,
                             -23.74192917,
                             -22.30002532,
                             -28.04246938,
                             -27.35462367,
                             -27.82140368,
                             -32.35142828,
                             -30.53506248,
                             -33.3685628,
                             -35.58461983,
                             -37.18127414,
                             -38.96444953,
                             -42.56962625,
                             -40.57929741,
                             -56.93973731,
                             -477.8463376};

void Butterworth50HzLPF(Bw50HzLPFTypeDef* pLPF) {
    pLPF->xv[0] = pLPF->xv[1];
    pLPF->xv[1] = pLPF->xv[2];
    pLPF->xv[2] = pLPF->xv[3];
    pLPF->xv[3] = pLPF->input / GAINBtw50hz;
    pLPF->yv[0] = pLPF->yv[1];
    pLPF->yv[1] = pLPF->yv[2];
    pLPF->yv[2] = pLPF->yv[3];
    pLPF->yv[3] = (pLPF->xv[0] + pLPF->xv[3]) + 3 * (pLPF->xv[1] + pLPF->xv[2]) +
                  (0.5320753683f * pLPF->yv[0]) + (-1.9293556691f * pLPF->yv[1]) +
                  (2.3740947437f * pLPF->yv[2]);

    pLPF->output = pLPF->yv[3];
}

fp64 Gyro_TableLookUp(fp64 DataAccu) {
    int i1, i2;
    i2 = (int)(-0.004582 * DataAccu + 80);
    if (i2 < 0)
        i2 = 0;
    else if (i2 > AD_Num - 1)
        i2 = AD_Num - 1;
    if (DataAccu > AD_Table[0])
        return AD_Table_a[0] * DataAccu + AD_Table_b[0];
    else if (DataAccu < AD_Table[AD_Num - 1])
        return AD_Table_a[AD_Num - 1] * DataAccu + AD_Table_b[AD_Num - 1];
    if (AD_Table[i2] > DataAccu) {
        for (i1 = i2; i1 <= AD_Num - 1; i1++) {
            if (AD_Table[i1] <= DataAccu) break;
        }
        return AD_Table_a[i1] * DataAccu + AD_Table_b[i1];
    } else {
        for (i1 = i2; i1 >= 0; i1--) {
            if (AD_Table[i1] >= DataAccu) break;
        }
        return AD_Table_a[i1 + 1] * DataAccu + AD_Table_b[i1 + 1];
    }
}
